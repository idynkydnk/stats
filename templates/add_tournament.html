{% extends 'base_admin.html' %}

{% block title %}Add Tournament{% endblock %}

<style>
.autocomplete {
    position: relative;
    display: inline-block;
    width: 100%;
    text-align: center;
}

.autocomplete input {
    width: 280px;
    padding: 6px;
    text-align: center;
}

.autocomplete-list {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 1px solid #ccc;
    background: white;
    z-index: 999;
    display: none;
    max-height: 150px;
    overflow-y: auto;
    width: 280px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.autocomplete-list div {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    font-size: 20px !important;
    line-height: 1.4;
    font-weight: normal !important;
}

.autocomplete-list div:hover {
    background: #f5f5f5;
}

.autocomplete-list div:last-child {
    border-bottom: none;
}
</style>

{% block content %}
<h1>Add Tournament</h1>
<div class="container">
    <form method="post">
        <datalist id="players">
            {% for display_name, full_name in all_players %}
                <option value="{{ full_name }}" data-display="{{ display_name }}">{{ display_name }}</option>
            {% endfor %}
        </datalist>
        <datalist id="teams">
            {% for team in teams %}
                <option value="{{ team }}"></option>
            {% endfor %}
        </datalist>
        <datalist id="locations">
            {% for location in locations %}
                <option value="{{ location }}"></option>
            {% endfor %}
        </datalist>
        <datalist id="tournament_names">
            {% for name in tournament_names %}
                <option value="{{ name }}"></option>
            {% endfor %}
        </datalist>
        
        <div class="form-group">
            <label for="tournament_date">Tournament Date</label>
            <input type="text" 
                   name="tournament_date" 
                   id="tournament_date"
                   placeholder="YYYY-MM-DD or MM/DD/YYYY"
                   value="{{ request.form.get('tournament_date', '') }}"
                   required>
            <small>Format: YYYY-MM-DD (e.g., 2025-11-15) or MM/DD/YYYY (e.g., 11/15/2025)</small>
        </div>
        
        <div class="form-group">
            <label for="place">Place</label>
            <input type="text" 
                   name="place" 
                   id="place"
                   placeholder="e.g., 1st, 2nd, 3rd, 5th, 9th"
                   value="{{ request.form.get('place', '') }}"
                   required>
        </div>
        
        <div class="form-group">
            <label for="team">Partner</label>
            <div class="autocomplete">
                <input type="text" 
                       name="team" 
                       id="team"
                       list="players"
                       placeholder="Partner name"
                       value="{{ request.form.get('team', '') }}"
                       onchange="updatePlayerOptions()"
                       required>
                <div class="autocomplete-list" id="teamList"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="location">Location</label>
            <div class="autocomplete">
                <input type="text" 
                       name="location" 
                       id="location"
                       list="locations"
                       placeholder="e.g., Hermosa Beach, Manhattan Beach"
                       value="{{ request.form.get('location', '') }}"
                       required>
                <div class="autocomplete-list" id="locationList"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="tournament_name">Tournament Name</label>
            <div class="autocomplete">
                <input type="text" 
                       name="tournament_name" 
                       id="tournament_name"
                       list="tournament_names"
                       placeholder="e.g., Spike N Go Solo, CBVA Open"
                       value="{{ request.form.get('tournament_name', '') }}"
                       required>
                <div class="autocomplete-list" id="tournament_nameList"></div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add Tournament</button>
            <a href="{{ url_for('tournaments') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
.container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: var(--text);
}

.form-group input {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--button-bg-1);
    border-radius: 8px;
    font-size: 16px;
    background-color: var(--table-bg);
    color: var(--text);
    box-sizing: border-box;
}

.form-group input:focus {
    outline: none;
    border-color: var(--button-bg-1);
    box-shadow: 0 0 5px rgba(174, 238, 152, 0.3);
}

.form-group small {
    display: block;
    margin-top: 5px;
    color: var(--caption);
    font-size: 12px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: var(--button-bg-1);
    color: var(--button-text-1);
}

.btn-primary:hover {
    background-color: var(--button-bg-1);
    opacity: 0.9;
    transform: translateY(-2px);
}

.btn-secondary {
    background-color: transparent;
    color: var(--button-bg-1);
    border: 2px solid var(--button-bg-1);
}

.btn-secondary:hover {
    background-color: var(--button-bg-1);
    color: var(--button-text-1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all options from datalists
    // For players, extract display names and full names
    const playerOptions = Array.from(document.getElementById('players').options);
    const playerMap = new Map(); // display_name -> full_name
    const allPlayersDisplay = [];
    playerOptions.forEach(opt => {
        const fullName = opt.value;
        const displayName = opt.getAttribute('data-display') || fullName;
        playerMap.set(displayName, fullName);
        allPlayersDisplay.push(displayName);
    });
    
    const allTeams = Array.from(document.getElementById('teams').options).map(opt => opt.value);
    const allLocations = Array.from(document.getElementById('locations').options).map(opt => opt.value);
    const allTournamentNames = Array.from(document.getElementById('tournament_names').options).map(opt => opt.value);
    
    // Setup autocomplete for partner field (shows display names, stores full names)
    const teamField = document.getElementById('team');
    const teamList = document.getElementById('teamList');
    if (teamField && teamList) {
        setupPlayerAutocomplete(teamField, teamList, allPlayersDisplay, playerMap);
    }
    
    // Setup autocomplete for location field
    const locationField = document.getElementById('location');
    const locationList = document.getElementById('locationList');
    if (locationField && locationList) {
        setupAutocomplete(locationField, locationList, allLocations);
    }
    
    // Setup autocomplete for tournament name field
    const tournamentNameField = document.getElementById('tournament_name');
    const tournamentNameList = document.getElementById('tournament_nameList');
    if (tournamentNameField && tournamentNameList) {
        setupAutocomplete(tournamentNameField, tournamentNameList, allTournamentNames);
    }
    
    // Hide lists when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.autocomplete')) {
            document.querySelectorAll('.autocomplete-list').forEach(list => {
                list.style.display = 'none';
            });
        }
    });
});

function setupAutocomplete(field, list, options) {
    field.addEventListener('focus', () => {
        showList(field, list, options);
    });
    
    field.addEventListener('input', () => {
        filterList(field, list, options);
    });
    
    list.addEventListener('click', (e) => {
        if (e.target.tagName === 'DIV') {
            field.value = e.target.textContent;
            list.style.display = 'none';
        }
    });
}

function setupPlayerAutocomplete(field, list, displayNames, playerMap) {
    field.addEventListener('focus', () => {
        showList(field, list, displayNames);
    });
    
    field.addEventListener('input', () => {
        filterList(field, list, displayNames);
    });
    
    list.addEventListener('click', (e) => {
        if (e.target.tagName === 'DIV') {
            const displayName = e.target.textContent;
            const fullName = playerMap.get(displayName) || displayName;
            // Store the full name in a hidden field or directly in the input
            field.value = fullName;
            // Also set a data attribute to track the display name
            field.setAttribute('data-display', displayName);
            list.style.display = 'none';
        }
    });
}

function showList(field, list, options) {
    list.innerHTML = '';
    options.slice(0, 12).forEach(option => {
        const div = document.createElement('div');
        div.textContent = option;
        list.appendChild(div);
    });
    list.style.display = 'block';
}

function filterList(field, list, options) {
    const inputValue = field.value.toLowerCase();
    const filtered = options.filter(opt => 
        opt.toLowerCase().includes(inputValue)
    );
    
    list.innerHTML = '';
    filtered.slice(0, 12).forEach(option => {
        const div = document.createElement('div');
        div.textContent = option;
        list.appendChild(div);
    });
    list.style.display = filtered.length > 0 ? 'block' : 'none';
}

function updatePlayerOptions() {
    // This function can be used to update player options if needed
    // Similar to the add_game page functionality
}
</script>
{% endblock %}
