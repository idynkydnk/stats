{% extends 'base.html' %}

{% block title %}AI Summary Preview{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ header_title }}</h1>
    <p class="subtitle">Subject: {{ subject }}</p>
</div>

<div class="card">
    <h2>Recipients</h2>
    {% if players %}
        <ul class="recipient-list">
        {% for player in players %}
            <li>{{ player.name }} &lt;{{ player.email }}&gt;</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No players with email addresses were found for the selected games.</p>
    {% endif %}

    {% if players_without_email %}
        <div class="warning-box">
            <strong>Missing emails for:</strong>
            <ul class="missing-email-list">
            {% for player in players_without_email %}
                <li>
                    <span class="player-name">{{ player }}</span>
                    <input type="email" id="email-input-{{ loop.index0 }}" placeholder="Add email for {{ player }}">
                    <button type="button" class="btn btn-small" onclick="saveEmail({{ player|tojson }}, 'email-input-{{ loop.index0 }}')">Save</button>
                </li>
            {% endfor %}
            </ul>
        </div>
    {% endif %}

    <div class="extra-recipient-box">
        <label for="additional-emails">Additional recipients (comma separated)</label>
        <textarea id="additional-emails" rows="2" placeholder="friend@example.com, coach@example.com"></textarea>
    </div>

    <div class="actions">
        <button id="confirm-send" class="btn btn-primary" onclick="confirmSend()" {% if not can_send %}disabled{% endif %}>
            Send Email
        </button>
        <a href="{{ back_url }}" class="btn btn-secondary">Back</a>
    </div>

    {% if not can_send %}
        <p class="note">Add email addresses for the players above to enable sending.</p>
    {% endif %}
</div>

<form id="refresh-form" method="post" action="{{ url_for('preview_ai_summary' if game_type == 'doubles' else 'preview_ai_summary_1v1') }}" style="display:none;">
    {% for gid in selected_game_ids %}
        <input type="hidden" name="game_ids" value="{{ gid }}">
    {% endfor %}
</form>

<div class="card">
    <h2>Email Preview</h2>
    <div class="email-preview">
        <iframe id="email-preview-frame" title="Email preview"></iframe>
    </div>
</div>

<style>
    .page-header { margin-bottom: 20px; }
    .subtitle { color: var(--caption); margin-top: 4px; }
    .card { margin-bottom: 24px; padding: 20px; background-color: var(--card-bg); border-radius: 16px; }
    .recipient-list { list-style: none; margin: 0; padding: 0; }
    .recipient-list li { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .recipient-list li:last-child { border-bottom: none; }
    .warning-box { margin-top: 16px; padding: 12px; border-radius: 8px; background: rgba(244, 67, 54, 0.2); border-left: 4px solid #f44336; }
    .warning-box ul { margin: 8px 0 0; padding: 0; list-style: none; }
    .missing-email-list { display: flex; flex-direction: column; gap: 8px; }
    .missing-email-list li { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .missing-email-list .player-name { font-weight: 600; color: #ffffff; }
    .missing-email-list input { flex: 1 1 220px; padding: 8px 10px; border-radius: 10px; border: 1px solid rgba(174, 238, 152, 0.6); background-color: rgba(17, 22, 28, 0.85); color: #ffffff; }
    .missing-email-list input::placeholder { color: rgba(174, 238, 152, 0.7); }
    .actions { display: flex; gap: 12px; align-items: center; margin-top: 16px; }
    .btn { padding: 10px 16px; border-radius: 10px; font-weight: 600; text-decoration: none; display: inline-block; cursor: pointer; }
    .btn-primary { background-color: #4CAF50; color: #fff; border: none; }
    .btn-primary[disabled] { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background-color: transparent; color: #aeee98; border: 1px solid #aeee98; }
    .btn-small { background-color: #aeee98; color: #102a43; border: none; padding: 6px 10px; border-radius: 8px; font-size: 13px; font-weight: 600; }
    .btn-small:hover { background-color: #7dd96c; }
    .email-preview { margin-top: 16px; background-color: #11161c; border-radius: 16px; padding: 0; overflow: hidden; border: 1px solid rgba(174, 238, 152, 0.2); height: 700px; }
    .email-preview iframe { width: 100%; height: 100%; border: none; background-color: #11161c; }
    .note { margin-top: 12px; color: #fbc02d; }
    .extra-recipient-box { margin-top: 16px; display: flex; flex-direction: column; gap: 6px; }
    .extra-recipient-box textarea { width: 100%; padding: 8px 10px; border-radius: 12px; border: 1px solid rgba(174, 238, 152, 0.6); background-color: rgba(17, 22, 28, 0.85); color: #ffffff; font-size: 14px; resize: vertical; min-height: 60px; }
    .extra-recipient-box textarea::placeholder { color: rgba(174, 238, 152, 0.7); }
</style>

<script>
    const selectedGameIds = JSON.parse('{{ selected_game_ids_json | safe }}');
    const emailHtml = {{ email_html | tojson | safe }};

    document.addEventListener('DOMContentLoaded', () => {
        const frame = document.getElementById('email-preview-frame');
        if (frame) {
            frame.srcdoc = emailHtml;
        }
    });

    function refreshPreview() {
        const form = document.getElementById('refresh-form');
        if (form) {
            form.submit();
        }
    }

    function saveEmail(playerName, inputId) {
        const input = document.getElementById(inputId);
        if (!input) {
            return;
        }
        const email = input.value.trim();
        if (!email) {
            alert('Please enter an email address before saving.');
            return;
        }

        fetch('{{ url_for("add_player_email") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                player_name: playerName,
                email: email,
                game_ids: selectedGameIds,
                game_type: {{ game_type|tojson }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Saved email for ${playerName}.`);
                refreshPreview();
            } else {
                alert('Error: ' + (data.error || 'Unable to save email.'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }

    function confirmSend() {
        const button = document.getElementById('confirm-send');
        if (!button || button.disabled) {
            return;
        }

        if (!confirm('Send this AI summary email to the listed recipients?')) {
            return;
        }

        const additionalField = document.getElementById('additional-emails');
        let additionalEmails = [];
        if (additionalField && additionalField.value.trim()) {
            additionalEmails = additionalField.value
                .split(/[,;\n]+/)
                .map(email => email.trim())
                .filter(email => email.length > 0);
        }

        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'Sending...';

        fetch('{{ send_url }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ game_ids: selectedGameIds, additional_emails: additionalEmails })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Email sent to ${data.emails_sent} player(s).`);
                window.location.href = '{{ back_url }}';
            } else {
                alert('Error: ' + (data.error || 'Unknown error occurred'));
                button.disabled = false;
                button.textContent = originalText;
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
            button.disabled = false;
            button.textContent = originalText;
        });
    }
</script>
{% endblock %}

