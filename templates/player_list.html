{% extends 'base.html' %}

{% block title %}Player List{% endblock %}

{% block content %}
<div class="container">
    <h1>Player List</h1>
    <div class="actions">
        <button class="btn-primary" type="button" onclick="openAddPlayerModal()">Add New Player</button>
    </div>
    
    {% if players %}
    <div class="search-container">
        <input type="text" id="playerSearch" placeholder="Search players..." onkeyup="searchPlayers()">
    </div>
    <p id="resultCount">Showing {{ players|length }} players</p>
    
    <table id="playerTable">
        <thead>
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Full Name</th>
                <th scope="col">Email</th>
                <th scope="col">Age</th>
                <th scope="col">Height</th>
                <th scope="col">Games</th>
                <th scope="col">First Game</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr>
                <td>{{ player[0] if player[0] else '-' }}</td>
                <td class="player_name">
                    {% if player[0] %}
                        <a href="{{ url_for('edit_player', player_id=player[0]) }}">{{ player[1] }}</a>
                    {% else %}
                        <a href="#"
                           data-player-name="{{ player[1]|e }}"
                           onclick="openAddPlayerModal(this.dataset.playerName); return false;">
                            {{ player[1] }}
                        </a>
                    {% endif %}
                </td>
                <td>{{ player[2] if player[2] else '-' }}</td>
                <td>{% if player[3] %}
                    {% set birth_year = player[3][:4]|int %}
                    {% set birth_month = player[3][5:7]|int %}
                    {% set birth_day = player[3][8:10]|int %}
                    {% set current_year = 2025 %}
                    {% set current_month = 11 %}
                    {% set current_day = 3 %}
                    {% set age = current_year - birth_year %}
                    {% if current_month < birth_month or (current_month == birth_month and current_day < birth_day) %}
                        {{ age - 1 }}
                    {% else %}
                        {{ age }}
                    {% endif %}
                {% else %}-{% endif %}</td>
                <td>{{ player[4] if player[4] else '-' }}</td>
                <td>{% if player|length > 9 and player[9] is number %}{{ player[9] }}{% else %}0{% endif %}</td>
                <td>{% if player|length > 8 and player[8] %}{{ player[8][5:7] }}/{{ player[8][8:10] }}/{{ player[8][2:4] }}{% else %}-{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No players in the database yet.</p>
    <p>Players will be added here as you migrate your existing player data or add new players.</p>
    {% endif %}
</div>

<!-- Add Player Modal -->
<div id="addPlayerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddPlayerModal()">&times;</span>
        <h2>Add New Player</h2>
        <form id="addPlayerForm" onsubmit="submitNewPlayer(event)">
            <div class="form-group">
                <label for="new-player-name">Full Name</label>
                <input type="text" id="new-player-name" name="full_name" placeholder="Full Name" required>
            </div>
            <div class="form-group">
                <label for="new-player-email">Email (optional)</label>
                <input type="email" id="new-player-email" name="email" placeholder="player@example.com">
            </div>
            <div class="form-group">
                <label for="new-player-dob">Date of Birth (optional)</label>
                <input type="date" id="new-player-dob" name="date_of_birth">
            </div>
            <div class="form-group">
                <label for="new-player-height">Height (optional)</label>
                <input type="text" id="new-player-height" name="height" placeholder="e.g. 6'1&quot;">
            </div>
            <div class="form-group">
                <label for="new-player-notes">Notes (optional)</label>
                <textarea id="new-player-notes" name="notes" rows="3" placeholder="Additional details"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-primary">Save Player</button>
                <button type="button" class="btn-secondary" onclick="closeAddPlayerModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 12px;
}

.btn-primary, .btn-secondary {
    padding: 8px 16px;
    border-radius: 10px;
    border: 1px solid var(--button-border-1);
    background-color: var(--button-bg-1);
    color: var(--button-text-1);
    font-weight: 600;
    cursor: pointer;
}

.btn-secondary {
    background-color: transparent;
    color: var(--button-bg-1);
}

.btn-primary:hover {
    border-color: var(--button-bg-1);
    background-color: var(--button-border-1);
    color: var(--button-bg-1);
}

.btn-secondary:hover {
    background-color: rgba(174, 238, 152, 0.15);
}

.search-container {
    text-align: center;
    margin: 20px 0;
}

#playerSearch {
    width: 280px;
    padding: 6px;
    text-align: center;
}

#resultCount {
    text-align: center;
    color: var(--caption);
    font-size: 14px;
    margin: 10px 0;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

th {
    background-color: var(--table-header-bg);
    font-weight: bold;
    position: sticky;
    top: 0;
}

tbody tr:hover {
    background-color: var(--table-hover-bg);
}

.player_name {
    font-weight: bold;
}

.player_name a {
    color: var(--text);
    text-decoration: none;
}

.player_name a:hover {
    color: var(--button-bg-1);
    text-decoration: underline;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    padding-top: 60px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}

.modal-content {
    background-color: #1d2025;
    margin: auto;
    padding: 20px;
    border: 1px solid #aeee98;
    border-radius: 16px;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
}

.close {
    color: #aaa;
    float: right;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #fff;
    text-decoration: none;
    cursor: pointer;
}

.form-group {
    margin-bottom: 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(174, 238, 152, 0.4);
    background-color: rgba(17, 22, 28, 0.9);
    color: #fff;
}

.form-group textarea {
    resize: vertical;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 12px;
}

p {
    margin: 10px 0;
    color: var(--caption);
}
</style>

<script>
function searchPlayers() {
    const input = document.getElementById('playerSearch');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('playerTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = tbody.getElementsByTagName('tr');
    const resultCount = document.getElementById('resultCount');
    
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const nameCell = row.getElementsByTagName('td')[1]; // Full Name is in second column
        const emailCell = row.getElementsByTagName('td')[2]; // Email is in third column
        
        if (nameCell && emailCell) {
            const name = nameCell.textContent || nameCell.innerText;
            const email = emailCell.textContent || emailCell.innerText;
            if (name.toLowerCase().indexOf(filter) > -1 || email.toLowerCase().indexOf(filter) > -1) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }
    
    resultCount.textContent = `Showing ${visibleCount} of {{ players|length }} players`;
}

function openAddPlayerModal(prefillName) {
    document.getElementById('addPlayerModal').style.display = 'block';
    const nameInput = document.getElementById('new-player-name');
    if (prefillName) {
        nameInput.value = prefillName;
    }
    // Focus for faster entry
    nameInput.focus();
}

function closeAddPlayerModal() {
    document.getElementById('addPlayerModal').style.display = 'none';
    document.getElementById('addPlayerForm').reset();
}

window.onclick = function(event) {
    const modal = document.getElementById('addPlayerModal');
    if (event.target === modal) {
        closeAddPlayerModal();
    }
};

function submitNewPlayer(event) {
    event.preventDefault();
    const form = event.target;
    const payload = {
        full_name: form.full_name.value.trim(),
        email: form.email.value.trim(),
        date_of_birth: form.date_of_birth.value,
        height: form.height.value.trim(),
        notes: form.notes.value.trim()
    };

    if (!payload.full_name) {
        alert('Full name is required.');
        return;
    }

    fetch('{{ url_for("api_add_player") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Player added successfully.');
            closeAddPlayerModal();
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unable to add player.'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock %}

