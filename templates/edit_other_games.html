{% extends 'base_admin.html' %}

{% block content %}
    <nav>
        <div class="dropdown">
            <button class="dropbtn">Select a year
                <i class="fa fa-caret-down"></i>
            </button>
            <div class="dropdown-content">
                {% for year in all_years %}
                    <a href="{{ url_for('edit_other_games_by_year', year=year) }}">{{ year }}</a>
                {% endfor %}
            </div>
        </div>       
    </nav>
    <h1>{% block title %} {{ year }} Other Games {% endblock %}</h1>
    <div>
        <button id="delete-selected-btn" onclick="deleteSelectedGames()" style="margin-bottom: 10px; padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete Selected</button>
        <table>
            <thead>
                <tr class="table-double-row">
                    <th scope="col" colspan="1"><input type="checkbox" id="select-all" onclick="toggleAllGames()"> Select</th>
                    <th scope="col" colspan="1">Date / Updated</th>
                    <th scope="col" colspan="1">Winners</th>
                    <th scope="col" colspan="1">Losers</th>
                    <th scope="col" colspan="1">Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for game in games %}
                <tr class="table-double-row">
                    <td rowspan="2"><input type="checkbox" class="game-checkbox" data-game-id="{{ game['game_id'] }}"></td>
                    <td>
                        {{ game["game_date_only"] }}<br>
                        {% if game["game_time"] %}
                            {{ game["game_time"] }}
                        {% endif %}
                    </td>
                    <td>
                        {% for winner in game["winners"] %}
                            <div class="player-line">
                                <a href="{{ url_for('other_player_stats', year=year, name=winner.name) }}">{{ winner.name }}</a>
                                {% if winner.score is not none %}
                                    <span class="player-score">{{ winner.score }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </td>
                    <td>
                        {% for loser in game["losers"] %}
                            <div class="player-line">
                                <a href="{{ url_for('other_player_stats', year=year, name=loser.name) }}">{{ loser.name }}</a>
                                {% if loser.score is not none %}
                                    <span class="player-score">{{ loser.score }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </td>
                    <td>
                        <a href="{{ url_for('update_other_game', id=game['game_id']) }}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="26"><path d="M3 17.46v3.04c0 .28.22.5.5.5h3.04c.13 0 .26-.05.35-.15L17.81 9.94l-3.75-3.75L3.15 17.1c-.1.1-.15.22-.15.36zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83l3.75 3.75l1.83-1.83z" fill="#aeee98"></path></svg></a>
                    </td>
                </tr>
                <tr class="table-double-row">
                    <td>
                        {{ game["updated_at"] }}
                    </td>
                    <td>
                        <strong>{{ game["game_type"] }}</strong><br>
                        <a href="{{ url_for('game_name_stats', game_name=game["game_name"]) }}">{{ game["game_name"] }}</a>
                    </td>
                    <td>
                        {{ game["comment"] or '' }}
                    </td>
                    <td>
                        <a href="{{ url_for('delete_other_game', id=game['game_id']) }}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="30"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z" fill="#aeee98"></path></svg></a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <style>
        .player-line {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        .player-line .player-score {
            font-weight: bold;
            color: #aeee98;
        }
    </style>

    <script>
    function toggleAllGames() {
        const selectAllCheckbox = document.getElementById('select-all');
        const gameCheckboxes = document.querySelectorAll('.game-checkbox');
        gameCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    function deleteSelectedGames() {
        const selectedCheckboxes = document.querySelectorAll('.game-checkbox:checked');
        const selectedGameIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-game-id'));
        
        if (selectedGameIds.length === 0) {
            alert('Please select at least one game to delete.');
            return;
        }
        
        if (!confirm(`Are you sure you want to delete ${selectedGameIds.length} game(s)? This cannot be undone.`)) {
            return;
        }
        
        let deletedCount = 0;
        const totalToDelete = selectedGameIds.length;
        
        selectedGameIds.forEach((gameId) => {
            fetch(`/delete_other_game/${gameId}/`, {
                method: 'POST',
            })
            .then(response => {
                deletedCount++;
                if (deletedCount === totalToDelete) {
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error deleting game:', error);
                deletedCount++;
                if (deletedCount === totalToDelete) {
                    location.reload();
                }
            });
        });
    }
    </script>
{% endblock %}